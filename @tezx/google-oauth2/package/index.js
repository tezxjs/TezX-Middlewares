import{auth}from"@googleapis/oauth2";import{generateID}from"tezx/helper";export function GoogleOauthClient(e){const{clientId:t,clientSecret:r,redirectUri:o}=e;return new auth.OAuth2(t,r,o)}export function getGoogleOAuthURL({scopes:e=["openid","email","profile"],authClient:t,loginHint:r,prompt:o="consent select_account",accessType:n="offline",includeGrantedScopes:i=!0}){return(s,a)=>{let c=`req-${generateID()}`;s.header("state",c);const u=t.generateAuthUrl({access_type:n,scope:e,state:c,login_hint:r,prompt:o,include_granted_scopes:i});return s.state.set("google",u),a?a():s.redirect(u)}}export function verifyGoogleToken({authClient:e,onError:t,Callbacks:r,onSuccess:o}){return async(n,i)=>{try{const s=n.req.query;if(s?.error){if(n.setStatus=500,t)return t(s.error,n);throw new Error(s.error)}if(s.code){const{tokens:a,res:c}=await e.getToken(s.code);e.setCredentials(a);const u=a?.id_token,l=await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${u}`),g=await l.json();if(g.aud!==e?._clientId)throw new Error("Invalid client ID");n.state.set("user",g);let h=r?.(n);if(h?.signIn){if(!await h.signIn(g)){if(n.setStatus=500,t)return t("Sign-in rejected",n);throw new Error("Sign-in rejected")}}let d=a;if(h?.jwt&&(d=await h.jwt(a,g)),h?.session){const e=await h.session({token:d},g);n.session=e}return await(o?.(d,c)),await i()}if(n.setStatus=500,t)return t("Missing authorization code",n);throw new Error("Missing authorization code")}catch(e){if(n.setStatus=500,t)return t(e.message,n);throw new Error(e?.message)}}}