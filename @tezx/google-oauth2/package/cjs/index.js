"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GoogleOauthClient=GoogleOauthClient,exports.getGoogleOAuthURL=getGoogleOAuthURL,exports.verifyGoogleToken=verifyGoogleToken;const oauth2_1=require("@googleapis/oauth2"),helper_1=require("tezx/helper");function GoogleOauthClient(e){const{clientId:t,clientSecret:o,redirectUri:r}=e;return new oauth2_1.auth.OAuth2(t,o,r)}function getGoogleOAuthURL({scopes:e=["openid","email","profile"],authClient:t,loginHint:o,prompt:r="consent select_account",accessType:n="offline",includeGrantedScopes:i=!0}){return(s,a)=>{let c=`req-${(0,helper_1.generateID)()}`;s.header("state",c);const u=t.generateAuthUrl({access_type:n,scope:e,state:c,login_hint:o,prompt:r,include_granted_scopes:i});return s.state.set("google",u),a?a():s.redirect(u)}}function verifyGoogleToken({authClient:e,onError:t,Callbacks:o,onSuccess:r}){return async(n,i)=>{try{const s=n.req.query;if(s?.error){if(n.setStatus=500,t)return t(s.error,n);throw new Error(s.error)}if(s.code){const{tokens:a,res:c}=await e.getToken(s.code);e.setCredentials(a);const u=a?.id_token,l=await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${u}`),g=await l.json();if(g.aud!==e?._clientId)throw new Error("Invalid client ID");n.state.set("user",g);let h=o?.(n);if(h?.signIn){if(!await h.signIn(g)){if(n.setStatus=500,t)return t("Sign-in rejected",n);throw new Error("Sign-in rejected")}}let d=a;if(h?.jwt&&(d=await h.jwt(a,g)),h?.session){const e=await h.session({token:d},g);n.session=e}return await(r?.(d,c)),await i()}if(n.setStatus=500,t)return t("Missing authorization code",n);throw new Error("Missing authorization code")}catch(e){if(n.setStatus=500,t)return t(e.message,n);throw new Error(e?.message)}}}